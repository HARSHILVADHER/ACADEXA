<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | Super Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-blue: #0d47a1;
            --secondary-blue: #1976d2;
            --dark-blue: #0a2e5a;
            --light-blue: #bbdefb;
            --white: #ffffff;
            --gray: #f8fafc;
            --accent-blue: #2196f3;
            --glass-effect: rgba(255, 255, 255, 0.15);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--gray);
            overflow-x: hidden;
        }
        
        .sidebar {
            width: 280px;
            transform: translateX(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, var(--glass-effect) 0%, rgba(13, 71, 161, 0.8) 100%);
            box-shadow: 0 8px 32px 0 rgba(13, 71, 161, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-collapsed {
            transform: translateX(-240px);
        }
        
        .main-content {
            margin-left: 280px;
            transition: all 0.4s ease;
        }
        
        .main-content-expanded {
            margin-left: 40px;
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        
        .card-hover:hover {
            transform: translateY(-8px) rotateX(5deg);
            box-shadow: 0 15px 35px rgba(13, 71, 161, 0.2);
        }
        
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue) 0%, var(--primary-blue) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card-hover:hover::before {
            opacity: 1;
        }
        
        .nav-item {
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--white);
            transition: width 0.3s ease;
        }
        
        .nav-item:hover::after {
            width: 100%;
        }
        
        .pulse {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(33, 150, 243, 0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            opacity: 0;
        }
        
        @keyframes fadeIn {
            0% { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .rotate {
            transition: transform 0.3s ease;
        }
        
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        .notification-badge {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
        }
    </style>
</head>
<body class="min-h-screen">
<div class="flex">
    <!-- Sidebar -->
    <div class="sidebar fixed h-screen gradient-bg text-white shadow-lg z-10">
        <div class="flex items-center justify-between p-6 border-b border-blue-300">
            <div class="flex items-center space-x-3">
                <h1 style="font-size: 30px;" class="text-xl font-bold">Acadexa</h1>
            </div>
            <button id="toggleSidebar" class="text-white focus:outline-none">
                <i class="fas fa-chevron-left rotate"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="flex items-center space-x-3 p-3 bg-blue-700 rounded-lg mb-6">
                <div class="relative">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin" class="w-10 h-10 rounded-full border-2 border-white">
                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-blue-700"></span>
                </div>
                <div>
                    <h3 class="font-semibold">Super Admin</h3>
                    <p class="text-xs text-blue-200">admin@nexus.com</p>
                </div>
            </div>
            <nav>
                <ul class="space-y-2">
                    <li><a href="superadmin.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-600 text-white"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                    <li><a href="user.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg bg-blue-700 text-white"><i class="fas fa-users"></i><span>User Management</span></a></li>
                    <li><a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-600 text-white"><i class="fas fa-user-shield"></i><span>Roles & Permissions</span></a></li>
                    <li><a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-600 text-white"><i class="fas fa-server"></i><span>System Settings</span></a></li>
                    <li><a href="#" class="nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-blue-600 text-white"><i class="fas fa-chart-line"></i><span>Analytics</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
    <!-- Main Content -->
    <div class="main-content w-full">
        <header class="bg-white shadow-sm">
            <div class="flex items-center justify-between p-4">
                <h2 class="text-xl font-bold text-gray-800">Dashboard Overview</h2>
                <div class="flex items-center space-x-6">
                </div>
            </div>
        </header>
        <!-- Responsive User Card -->
        <div class="flex justify-center transition-all duration-300">
            <div id="userCard" class="bg-white shadow-xl rounded-[18px] px-7 py-8 max-w-[900px] w-[95%] mt-12">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-5 gap-3">
                    <h2 class="text-xl font-bold text-gray-900">Users</h2>
                    <button id="addUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold text-sm px-5 py-2 rounded-md shadow-md transition">Add User</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-[#f3f6fd] text-blue-700 font-semibold text-left">
                                <th class="py-2 px-2">#</th>
                                <th class="py-2 px-2">Full Name</th>
                                <th class="py-2 px-2">Username</th>
                                <th class="py-2 px-2">Email</th>
                                <th class="py-2 px-2">Phone</th>
                                <th class="py-2 px-2">Institute Code</th>
                                <th class="py-2 px-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-gray-400 py-5">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Add User Modal -->
<div id="addUserModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAddUserModal" class="absolute top-2 right-3 text-gray-500 hover:text-red-500 text-2xl">&times;</button>
    <h3 class="text-lg font-bold mb-4">Add User</h3>
    <form id="addUserForm">
      <div class="mb-3">
        <label class="block mb-1 font-medium">Full Name</label>
        <input type="text" name="full_name" class="w-full border rounded px-3 py-2" required>
      </div>
      <div class="mb-3">
        <label class="block mb-1 font-medium">Username</label>
        <input type="text" name="username" class="w-full border rounded px-3 py-2" required>
      </div>
      <div class="mb-3">
        <label class="block mb-1 font-medium">Email</label>
        <input type="email" name="email" class="w-full border rounded px-3 py-2" required>
      </div>
      <div class="mb-3">
        <label class="block mb-1 font-medium">Phone</label>
        <input type="text" name="phone_number" class="w-full border rounded px-3 py-2" required>
      </div>

      <div class="mb-3">
        <label class="block mb-1 font-medium">Institute Code</label>
        <input type="text" id="institute_code" name="institute_code" class="w-full border rounded px-3 py-2 bg-gray-100" maxlength="4" readonly required>
      </div>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded w-full mt-2">Add User</button>
    </form>
  </div>
</div>
<!-- Add Email Preview Modal -->
<div id="emailPreviewModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeEmailPreviewModal" class="absolute top-2 right-3 text-gray-500 hover:text-red-500 text-2xl">&times;</button>
    <h3 class="text-lg font-bold mb-4">Send Welcome Email</h3>
    <div id="emailPreviewContent" class="mb-4 text-gray-800 whitespace-pre-line"></div>
    <button id="sendEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded w-full mt-2">Send Email</button>
    <div id="emailSendStatus" class="mt-3 text-center text-sm"></div>
  </div>
</div>
<script>
    const toggleSidebar = document.getElementById('toggleSidebar');
const sidebar = document.querySelector('.sidebar');
const mainContent = document.querySelector('.main-content');

toggleSidebar.addEventListener('click', () => {
    sidebar.classList.toggle('sidebar-collapsed');
    mainContent.classList.toggle('main-content-expanded');
    toggleSidebar.querySelector('i').classList.toggle('rotate-180');
});

// Fetch and display users
async function loadUsers() {
  const tbody = document.getElementById('userTableBody');
  tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-5">Loading users...</td></tr>';

  try {
    // First, try to create the users table if it doesn't exist
    await fetch('php/create_users_table.php');
    
    const res = await fetch('php/get_users.php');
    if (!res.ok) {
      throw new Error('Network response was not ok');
    }
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error('Invalid JSON response:', text);
      throw new Error('Server returned invalid JSON');
    }

    if (data.success && data.users.length) {
      tbody.innerHTML = data.users.map((u, i) => `
        <tr class="border-b border-gray-100" id="user-row-${u.id}">
          <td class="py-2 px-2">${i + 1}</td>
          <td class="py-2 px-2">${u.full_name && u.full_name !== 'null' ? u.full_name : ''}</td>
          <td class="py-2 px-2">${u.username && u.username !== 'null' ? u.username : ''}</td>
          <td class="py-2 px-2">${u.email && u.email !== 'null' ? u.email : ''}</td>
          <td class="py-2 px-2">${u.phone_number && u.phone_number !== 'null' ? u.phone_number : ''}</td>
          <td class="py-2 px-2">${u.institute_code && u.institute_code !== 'null' ? u.institute_code : ''}</td>
          <td class="py-2 px-2 flex gap-2">
            <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" data-id="${u.id}" title="Delete"><i class="fas fa-trash"></i></button>
            <button class="block-btn ${u.blocked == 1 ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white px-2 py-1 rounded text-xs" data-id="${u.id}" data-blocked="${u.blocked}" title="${u.blocked == 1 ? 'Unblock' : 'Block'}">
              <i class="fas ${u.blocked == 1 ? 'fa-unlock' : 'fa-ban'}"></i>
            </button>
            <button class="mail-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" data-id="${u.id}" title="Mail"><i class="fas fa-envelope"></i></button>
          </td>
        </tr>
      `).join('');

      // --- DELETE USER ---
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async function () {
          const id = this.getAttribute('data-id');
          if (!confirm('Are you sure you want to delete this user?')) return;

          console.log('Deleting user with id:', id);
          const res = await fetch('php/delete_user.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + encodeURIComponent(id)
          });

          let result;
          try {
            const text = await res.text();
            result = JSON.parse(text);
          } catch (e) {
            console.error('Invalid JSON response:', text);
            result = { success: false, error: 'Invalid JSON or server error.' };
          }

          console.log('Delete response:', result);

          if (result.success) {
            loadUsers(); // Refresh table
          } else {
            let errDiv = document.getElementById('user-error');
            if (!errDiv) {
              errDiv = document.createElement('div');
              errDiv.id = 'user-error';
              errDiv.style.color = 'red';
              errDiv.style.textAlign = 'center';
              errDiv.style.margin = '10px 0';
              document.getElementById('userCard').prepend(errDiv);
            }
            errDiv.textContent = result.error || 'Failed to delete user.';
            setTimeout(() => { errDiv.textContent = ''; }, 4000);
          }
        };
      });

      // --- BLOCK/UNBLOCK USER ---
      document.querySelectorAll('.block-btn').forEach(btn => {
        btn.onclick = async function () {
          const id = this.getAttribute('data-id');
          const blocked = this.getAttribute('data-blocked');
          const action = blocked === '1' ? 'Unblock' : 'Block';

          if (!confirm(`${action} this user?`)) return;

          const res = await fetch('php/block_user.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + encodeURIComponent(id)
          });

          let result;
          try {
            const text = await res.text();
            result = JSON.parse(text);
          } catch (e) {
            console.error('Invalid JSON response:', text);
            result = { success: false, error: 'Server error' };
          }
          if (result.success) loadUsers();
          else alert(result.error || `Failed to ${action.toLowerCase()} user.`);
        };
      });

      // --- MAIL BUTTON ---
      document.querySelectorAll('.mail-btn').forEach(btn => {
        btn.onclick = async function () {
          const id = this.getAttribute('data-id');
          // Fetch user data from backend
          try {
            const res = await fetch('php/get_users.php');
            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch (e) {
              console.error('Invalid JSON response:', text);
              return;
            }
            if (data.success && data.users.length) {
              const user = data.users.find(u => u.id == id);
              if (!user) {
                alert('User not found!');
                return;
              }
              // Prepare email preview
              const preview = `Welcome to Acadexa\n\nDear ${user.full_name},\n\nYour login credentials:\nEmail: ${user.email}\nUsername: ${user.username}\nInstitute Code: ${user.institute_code}\n\nPlease visit our platform and set your password on first login.\n\nBest regards,\nAcadexa Team`;
              document.getElementById('emailPreviewContent').textContent = preview;
              document.getElementById('emailPreviewModal').classList.remove('hidden');
              // Store user info for sending
              document.getElementById('sendEmailBtn').dataset.email = user.email;
              document.getElementById('sendEmailBtn').dataset.name = user.full_name;
              document.getElementById('sendEmailBtn').dataset.username = user.username;
              document.getElementById('sendEmailBtn').dataset.institute_code = user.institute_code;
            } else {
              alert('Failed to fetch user data.');
            }
          } catch (e) {
            alert('Error fetching user data.');
          }
        };
      });

    } else {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-5">No users found.</td></tr>';
    }

  } catch (e) {
    console.error('Error loading users:', e);
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 py-5">Error loading users. Please check the console for details.</td></tr>';
  }
}
loadUsers();

// Re-load users after user is added
if (document.getElementById('addUserForm')) {
  document.getElementById('addUserForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);

    // Send data to backend
    const res = await fetch('php/add_user.php', {
      method: 'POST',
      body: formData
    });
    let result;
    let text;
    try {
      text = await res.text();
      result = JSON.parse(text);
    } catch (e) {
      console.error('Invalid JSON response:', text);
      result = { success: false, error: 'Server error' };
    }

    if (result.success) {
      // Optionally show a success message
      form.reset();
      document.getElementById('addUserModal').classList.add('hidden');
      loadUsers();
    } else {
      alert(result.error || 'Failed to add user.');
    }
  });
}

// JS to auto-generate code
function generateInstituteCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 4; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// On form open/reset
document.getElementById('institute_code').value = generateInstituteCode();

// Show Add User Modal
  document.getElementById('addUserBtn').onclick = function() {
    document.getElementById('addUserModal').classList.remove('hidden');
    document.getElementById('institute_code').value = generateInstituteCode();
  };
  // Close Modal
  document.getElementById('closeAddUserModal').onclick = function() {
    document.getElementById('addUserModal').classList.add('hidden');
  };
  // Optional: Close modal when clicking outside the form
  document.getElementById('addUserModal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.add('hidden');
  });

// Close Email Preview Modal
if (document.getElementById('closeEmailPreviewModal')) {
  document.getElementById('closeEmailPreviewModal').onclick = function() {
    document.getElementById('emailPreviewModal').classList.add('hidden');
    document.getElementById('emailSendStatus').textContent = '';
  };
  document.getElementById('emailPreviewModal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.add('hidden');
      document.getElementById('emailSendStatus').textContent = '';
    }
  });
}
// Send Email Button
if (document.getElementById('sendEmailBtn')) {
  document.getElementById('sendEmailBtn').onclick = async function() {
    const email = this.dataset.email;
    const name = this.dataset.name;
    const username = this.dataset.username;
    const institute_code = this.dataset.institute_code;
    // Password will be set by the user on their first login
    document.getElementById('emailSendStatus').textContent = 'Sending...';
    try {
      const res = await fetch('php/send_user_mail.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `email=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&username=${encodeURIComponent(username)}&institute_code=${encodeURIComponent(institute_code)}`
      });
      let result;
      try {
        const text = await res.text();
        result = JSON.parse(text);
      } catch (e) {
        console.error('Invalid JSON response:', text);
        result = { success: false, error: 'Server error' };
      }
      if (result.success) {
        document.getElementById('emailSendStatus').textContent = 'Email sent successfully!';
      } else {
        document.getElementById('emailSendStatus').textContent = 'Failed to send email: ' + (result.error || 'Unknown error');
      }
    } catch (e) {
      document.getElementById('emailSendStatus').textContent = 'Error sending email.';
    }
  };
}

</script>
</body>
</html>
